<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç¡çœ è‰ºæœ¯ V6.0 (é€šç”¨åˆ†äº«ç‰ˆ)</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸŒ™</text></svg>">
    
    <script src="https://unpkg.com/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script src="https://unpkg.com/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
    <script src="https://unpkg.com/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    
    <style>
        :root { --primary: #6a89cc; --bg: #fdfdfd; --font: -apple-system, sans-serif; }
        body { font-family: var(--font); background: var(--bg); color: #444; margin: 0; padding: 15px; padding-bottom: 50px; display: flex; flex-direction: column; align-items: center; -webkit-tap-highlight-color: transparent; }
        
        /* é¡¶éƒ¨å·¥å…·æ  */
        .toolbar { width: 100%; max-width: 600px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .app-title { font-size: 16px; font-weight: bold; color: #555; letter-spacing: 1px; }
        .tool-link { font-size: 13px; color: #6a89cc; text-decoration: underline; cursor: pointer; border: none; background: none; padding: 5px; }

        /* æŠ˜å é¢æ¿é€šç”¨æ ·å¼ */
        .collapse-panel { display: none; width: 100%; max-width: 600px; background: #fff; border: 2px dashed #ddd; padding: 15px; margin-bottom: 20px; border-radius: 10px; box-sizing: border-box; }
        .panel-title { font-size: 13px; font-weight: bold; color: #555; margin-bottom: 10px; display: block; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        
        /* è®¾ç½®åŒºåŸŸ */
        .setting-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; font-size: 13px; }
        .setting-input { padding: 5px; border: 1px solid #ddd; border-radius: 5px; width: 80px; text-align: center; }

        /* å¤‡ä»½åŒºåŸŸæŒ‰é’® */
        .btn-row { display: flex; gap: 10px; margin-top: 10px; }
        .sm-btn { flex: 1; padding: 8px 0; border-radius: 6px; border: 1px solid #ddd; background:#f9f9f9; font-size: 12px; color: #555; cursor: pointer; }
        .btn-primary { background: var(--primary); color: white; border:none; }
        .btn-danger { background: #ff7675; color: white; border:none; }
        textarea { width: 100%; height: 50px; font-family: monospace; font-size: 12px; border: 1px solid #eee; background: #fafafa; padding: 5px; resize: none; border-radius: 6px; margin-bottom: 5px; box-sizing: border-box;}
        #fileInput { display: none; }

        /* è¾“å…¥é¢æ¿ */
        .input-panel { background: white; padding: 18px; border-radius: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px; width: 100%; max-width: 600px; box-sizing: border-box; }
        .input-row { display: flex; gap: 10px; flex-wrap: wrap; justify-content: space-between; }
        .input-group { display: flex; flex-direction: column; flex: 1; min-width: 85px; }
        label { font-size: 12px; color: #888; margin-bottom: 6px; }
        input[type="date"], input[type="time"], input[type="text"] { padding: 10px; border: 1px solid #eee; border-radius: 8px; font-size: 16px; background: #fafafa; width: 100%; box-sizing: border-box; appearance: none; }
        .note-input { width: 100%; font-size: 14px; } /* å¤‡æ³¨æ¡†æ ·å¼ */
        .main-btn { padding: 12px 0; background-color: var(--primary); color: white; border: none; border-radius: 8px; font-size: 15px; font-weight: 600; width: 100%; cursor: pointer; margin-top: 5px;}

        /* å›¾è¡¨ */
        .chart-container-wrapper { width: 100%; max-width: 1000px; overflow-x: auto; background: white; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.03); padding: 10px; margin-bottom: 30px; min-height: 200px; scroll-behavior: smooth;}
        .chart-body { position: relative; height: 500px; min-width: 100%; }
        #offlineTip { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #999; font-size: 12px; text-align: center; width: 100%; display: none;}

        /* è¡¨æ ¼ */
        .history-panel { width: 100%; max-width: 600px; margin-bottom: 60px; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; table-layout: fixed; } /* å›ºå®šå¸ƒå±€é˜²æ­¢å¤‡æ³¨æ’‘çˆ† */
        th { color: #999; font-weight: 500; text-align: left; padding: 10px 5px; border-bottom: 1px solid #eee; }
        td { padding: 12px 5px; border-bottom: 1px solid #f9f9f9; color: #555; vertical-align: top; }
        .note-text { display: block; font-size: 11px; color: #999; margin-top: 4px; font-style: italic; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 100px;}
        .act-btn { background: #f1f2f6; color: #555; border:none; padding:4px 8px; border-radius:4px; font-size: 11px; margin-right: 4px;}
        
        #statusMsg { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: white; padding: 10px 20px; border-radius: 20px; font-size: 14px; display: none; pointer-events: none; z-index: 9999; box-shadow: 0 4px 10px rgba(0,0,0,0.2); white-space: nowrap;}
    </style>
</head>
<body>

    <div id="statusMsg"></div>

    <div class="toolbar">
        <span class="app-title">ğŸŒ™ ç¡çœ è‰ºæœ¯</span>
        <div style="display:flex; gap:10px;">
            <button class="tool-link" onclick="togglePanel('settingsPanel')">âš™ï¸ è®¾ç½®</button>
            <button class="tool-link" onclick="togglePanel('backupPanel')">ğŸ›  ç®¡ç†</button>
        </div>
    </div>

    <div id="settingsPanel" class="collapse-panel">
        <span class="panel-title">ä¸ªæ€§åŒ–è®¾ç½®</span>
        <div class="setting-row">
            <label>æˆ‘çš„ç†¬å¤œçº¢çº¿ (è¶…è¿‡å˜è“)</label>
            <input type="time" id="limitTimeInput" class="setting-input" value="03:00" onchange="saveSettings()">
        </div>
        <div style="font-size:11px; color:#999; margin-top:5px;">
            * æ­¤æ—¶é—´ä¹‹å‰å…¥ç¡æ˜¾ç¤ºä¸ºé»„è‰²åœ†ç‚¹ï¼Œ0ç‚¹å‰å…¥ç¡æ˜¾ç¤ºä¸ºæ˜Ÿæ˜Ÿã€‚
        </div>
    </div>

    <div id="backupPanel" class="collapse-panel">
        <span class="panel-title">æ•°æ®ç®¡ç†</span>
        <div class="btn-row">
            <button class="sm-btn" onclick="exportFile()">ğŸ“¤ å¯¼å‡ºæ–‡ä»¶</button>
            <button class="sm-btn btn-primary" onclick="document.getElementById('fileInput').click()">ğŸ“¥ å¯¼å…¥æ–‡ä»¶</button>
            <input type="file" id="fileInput" accept=".json" onchange="importFile(this)">
        </div>
        <div class="btn-row">
            <button class="sm-btn" onclick="copyTextData()">ğŸ“‹ å¤åˆ¶æ–‡æœ¬</button>
            <button class="sm-btn" onclick="pasteTextData()">ğŸ”„ ç²˜è´´æ¢å¤</button>
        </div>
        <textarea id="dataBox" placeholder="æ–‡æœ¬æ•°æ®äº¤æ¢åŒº..." style="margin-top:10px;"></textarea>
        <div class="btn-row" style="margin-top:15px; border-top:1px solid #eee; padding-top:10px;">
            <button class="sm-btn btn-danger" onclick="clearAllData()">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰æ•°æ® (æ…ç”¨)</button>
            <button class="sm-btn" onclick="resetDemoData()">â™»ï¸ æ¢å¤ç¤ºèŒƒæ•°æ®</button>
        </div>
    </div>

    <div class="input-panel">
        <div class="input-row">
            <div class="input-group">
                <label>æ—¥æœŸ</label>
                <input type="date" id="dateInput">
            </div>
            <div class="input-group">
                <label>å…¥ç¡</label>
                <input type="time" id="bedInput" value="02:00">
            </div>
            <div class="input-group">
                <label>é†’æ¥</label>
                <input type="time" id="wakeInput" value="10:30">
            </div>
        </div>
        <div class="input-group" style="width:100%">
            <label>å¤‡æ³¨ (é€‰å¡«)</label>
            <input type="text" id="noteInput" class="note-input" placeholder="ä¾‹å¦‚ï¼šçœ‹å®Œäº†ä¸€æœ¬å¥½ä¹¦ / åŠ ç­...">
        </div>
        <button class="main-btn" onclick="addData()">âœ¨ è®°å½•ç¡çœ </button>
    </div>

    <div class="chart-container-wrapper">
        <div class="chart-body" id="chartBody">
            <div id="offlineTip">å›¾è¡¨åŠ è½½ä¸­...</div>
            <canvas id="sleepChart"></canvas>
        </div>
    </div>

    <div class="history-panel">
        <h3>å†å²è®°å½•</h3>
        <table id="historyTable">
            <thead><tr><th style="width:25%">æ—¥æœŸ</th><th style="width:30%">æ—¶é—´/å¤‡æ³¨</th><th>çŠ¶æ€</th><th style="width:20%">æ“ä½œ</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>

    <script>
        // --- ç¤ºèŒƒæ•°æ® (ä»…ä¿ç•™3æ¡ä¸åŒç±»å‹çš„) ---
        const DEMO_DATA = [
            {"date":"2025-11-20","bedTime":"23:30","wakeTime":"07:30","duration":8,"startVal":23.5,"endVal":31.5,"score":100,"note":"æ—©ç¡å¥–åŠ±âœ¨"},
            {"date":"2025-11-21","bedTime":"02:15","wakeTime":"10:00","duration":7.75,"startVal":26.25,"endVal":34,"score":86,"note":"çœ‹ç”µå½±"},
            {"date":"2025-11-22","bedTime":"04:30","wakeTime":"11:00","duration":6.5,"startVal":28.5,"endVal":35,"score":65,"note":"èµ¶Deadline"}
        ];

        // --- åˆå§‹åŒ–æ•°æ®ä¸è®¾ç½® ---
        let sleepData = JSON.parse(localStorage.getItem('mySleepData_v6'));
        // å¦‚æœæ²¡æœ‰æ•°æ®ï¼ŒåŠ è½½ç¤ºèŒƒæ•°æ®
        if (!sleepData) {
            sleepData = JSON.parse(JSON.stringify(DEMO_DATA)); // æ·±åº¦å¤åˆ¶
            localStorage.setItem('mySleepData_v6', JSON.stringify(sleepData));
        }

        // è¯»å–ç”¨æˆ·è®¾ç½® (çº¢çº¿æ—¶é—´)
        let userSettings = JSON.parse(localStorage.getItem('mySleepSettings')) || { limitTime: '03:00' };
        document.getElementById('limitTimeInput').value = userSettings.limitTime;
        
        try { 
            if(typeof Chart !== 'undefined') {
                Chart.register(window['chartjs-plugin-annotation']); 
                Chart.register(ChartDataLabels);
            } else { document.getElementById('offlineTip').style.display = 'block'; }
        } catch(e) {}

        // --- äº¤äº’åŠŸèƒ½ ---
        function showMsg(text) {
            const el = document.getElementById('statusMsg');
            el.innerText = text; el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 3000);
        }
        function togglePanel(id) {
            // å…³é—­å…¶ä»–é¢æ¿
            ['settingsPanel', 'backupPanel'].forEach(pid => {
                if(pid !== id) document.getElementById(pid).style.display = 'none';
            });
            const el = document.getElementById(id);
            el.style.display = (el.style.display === 'block') ? 'none' : 'block';
        }

        // --- è®¾ç½®ç®¡ç† ---
        function saveSettings() {
            const val = document.getElementById('limitTimeInput').value;
            if(val) {
                userSettings.limitTime = val;
                localStorage.setItem('mySleepSettings', JSON.stringify(userSettings));
                saveAndRender(); // é‡æ–°æ¸²æŸ“å›¾è¡¨ä»¥æ›´æ–°çº¢çº¿
                showMsg("âœ… è®¾ç½®å·²ä¿å­˜");
            }
        }

        // --- æ•°æ®ç®¡ç† ---
        function clearAllData() {
            if(confirm("âš ï¸ ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿ\næ­¤æ“ä½œæ— æ³•æ’¤é”€ï¼")) {
                sleepData = [];
                saveAndRender();
                showMsg("å·²æ¸…ç©ºæ‰€æœ‰æ•°æ®");
            }
        }
        function resetDemoData() {
            if(confirm("ç¡®å®šè¦æ¢å¤åˆ°åˆå§‹çš„3æ¡ç¤ºèŒƒæ•°æ®å—ï¼Ÿ\nå½“å‰æ•°æ®å°†è¢«è¦†ç›–ï¼")) {
                sleepData = JSON.parse(JSON.stringify(DEMO_DATA));
                saveAndRender();
                showMsg("å·²æ¢å¤ç¤ºèŒƒæ•°æ®");
            }
        }
        function exportFile() {
            if(sleepData.length === 0) return showMsg("âŒ æ²¡æœ‰æ•°æ®");
            const blob = new Blob([JSON.stringify(sleepData, null, 2)], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url;
            a.download = `sleep_backup_${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
            showMsg("âœ… æ–‡ä»¶å·²ç”Ÿæˆ");
        }
        function importFile(input) {
            const file = input.files[0]; if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const json = JSON.parse(e.target.result);
                    if(Array.isArray(json)) { sleepData = json; saveAndRender(); showMsg(`âœ… å¯¼å…¥ ${json.length} æ¡æ•°æ®`); togglePanel('backupPanel'); } 
                    else { showMsg("âŒ æ ¼å¼é”™è¯¯"); }
                } catch(err) { showMsg("âŒ æ–‡ä»¶æ— æ³•è¯»å–"); }
                input.value = '';
            }; reader.readAsText(file);
        }
        function copyTextData() {
            const str = JSON.stringify(sleepData);
            document.getElementById('dataBox').value = str;
            document.getElementById('dataBox').select();
            document.execCommand('copy'); // å…¼å®¹æ—§è®¾å¤‡
            showMsg("âœ… æ•°æ®å·²å¤åˆ¶åˆ°å‰ªè´´æ¿");
        }
        function pasteTextData() {
            const raw = document.getElementById('dataBox').value.trim();
            if(!raw) return showMsg("âŒ æ¡†é‡Œæ˜¯ç©ºçš„");
            try {
                const json = JSON.parse(raw);
                if(Array.isArray(json)) { sleepData = json; saveAndRender(); showMsg(`âœ… æ¢å¤ ${json.length} æ¡æ•°æ®`); togglePanel('backupPanel'); } 
                else { showMsg("âŒ æ ¼å¼é”™è¯¯"); }
            } catch(e) { showMsg("âŒ ä»£ç ä¸å®Œæ•´"); }
        }

        // --- æ ¸å¿ƒé€»è¾‘ ---
        function timeToNumber(timeStr) {
            const [h, m] = timeStr.split(':').map(Number);
            let val = h + m / 60;
            // 21:00 å‰çš„æ—¶é—´ç®—æ¬¡æ—¥ (é€‚é…å¤§éƒ¨åˆ†å¤œçŒ«å­ï¼Œå…è®¸æ—©ç¡åˆ°21ç‚¹)
            if (val < 21) val += 24;
            return val;
        }
        function numberToTime(num) {
            if (num >= 24) num -= 24;
            let h = Math.floor(num);
            let m = Math.round((num - h) * 60);
            if (m === 60) { h += 1; m = 0; }
            return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
        }

        // è¯„åˆ†é€»è¾‘ (åŠ¨æ€çº¢çº¿)
        function calculateScore(duration, startVal) {
            let score = 100;
            // 1. æ—¶é•¿åˆ†
            if (duration < 7) score -= (7 - duration) * 10; 
            if (duration > 10) score -= (duration - 10) * 5;
            
            // 2. å…¥ç¡åˆ† (åŸºäºç”¨æˆ·è®¾å®šçš„çº¢çº¿)
            // å…ˆè§£æç”¨æˆ·çº¢çº¿æ—¶é—´
            let limitVal = timeToNumber(userSettings.limitTime);
            // å¦‚æœçº¢çº¿è®¾å¾—å¤ªæ—©(æ¯”å¦‚22ç‚¹)ï¼Œå¯¼è‡´æ•°å€¼å¾ˆå¤§(46)ï¼Œé€»è¾‘å¯èƒ½è¦å¾®è°ƒï¼Œä½†è¿™é‡Œé€šç”¨é€»è¾‘æ˜¯æ¯”è¾ƒå·®å€¼
            
            // åªæœ‰å½“å…¥ç¡æ—¶é—´ æ™šäº çº¢çº¿ æ‰æ‰£åˆ†
            if (startVal > limitVal) {
                let delay = startVal - limitVal;
                score -= delay * 5; // æ¯æ™šäºçº¢çº¿1å°æ—¶æ‰£5åˆ†
            }
            return Math.max(0, Math.min(100, Math.round(score)));
        }

        function addData() {
            const date = document.getElementById('dateInput').value;
            const bedTime = document.getElementById('bedInput').value;
            const wakeTime = document.getElementById('wakeInput').value;
            const note = document.getElementById('noteInput').value.trim(); // è·å–å¤‡æ³¨

            if (!date || !bedTime || !wakeTime) return showMsg("âŒ è¯·å¡«å†™å®Œæ•´");
            
            const existingIndex = sleepData.findIndex(d => d.date === date);
            if (existingIndex >= 0) {
                if(!confirm(`âš ï¸ æ—¥æœŸ ${date} å·²å­˜åœ¨ï¼\nç¡®å®šè¦è¦†ç›–å—ï¼Ÿ`)) return;
            }

            let startVal = timeToNumber(bedTime);
            let endVal = timeToNumber(wakeTime);
            if (endVal < startVal) endVal += 24;
            let duration = parseFloat((endVal - startVal).toFixed(2));
            let score = calculateScore(duration, startVal);

            const newData = { date, bedTime, wakeTime, duration, startVal, endVal, score, note };
            if (existingIndex >= 0) { sleepData[existingIndex] = newData; showMsg("âœ… å·²æ›´æ–°"); } 
            else { sleepData.push(newData); showMsg("âœ… å·²è®°å½•"); }
            
            sleepData.sort((a, b) => new Date(a.date) - new Date(b.date));
            saveAndRender(); 
            
            // è®°å½•åæ¸…ç©ºå¤‡æ³¨æ¡†
            document.getElementById('noteInput').value = '';
            
            // æ»šåŠ¨åˆ°æœ€å³
            setTimeout(() => {
                const wrapper = document.querySelector('.chart-container-wrapper');
                wrapper.scrollLeft = wrapper.scrollWidth;
            }, 100);
        }

        function editData(index) {
            // index æ˜¯åŸå§‹æ•°æ®çš„ç´¢å¼•
            const item = sleepData[index];
            document.getElementById('dateInput').value = item.date;
            document.getElementById('bedInput').value = item.bedTime;
            document.getElementById('wakeInput').value = item.wakeTime;
            document.getElementById('noteInput').value = item.note || ''; // å›å¡«å¤‡æ³¨
            
            sleepData.splice(index, 1); saveAndRender(); 
            window.scrollTo({top:0, behavior:'smooth'}); 
            showMsg("ğŸ“ æ•°æ®å·²æå–ï¼Œè¯·ä¿®æ”¹åä¿å­˜");
        }
        function deleteData(index) { 
            if(confirm("ç¡®å®šåˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ")) {
                sleepData.splice(index, 1); saveAndRender(); showMsg("ğŸ—‘ï¸ å·²åˆ é™¤"); 
            }
        }
        function saveAndRender() { localStorage.setItem('mySleepData_v6', JSON.stringify(sleepData)); renderTable(); renderChart(); }
        
        function renderTable() {
            const tbody = document.querySelector('#historyTable tbody');
            tbody.innerHTML = '';
            // å€’åºæ˜¾ç¤º
            const reversedData = sleepData.map((item, index) => ({item, index})).reverse();

            reversedData.forEach(({item, index}) => {
                // æ¯æ¬¡æ¸²æŸ“é‡ç®—åˆ†æ•° (å› ä¸ºçº¢çº¿å¯èƒ½å˜äº†)
                item.score = calculateScore(item.duration, item.startVal);
                
                const noteHtml = item.note ? `<span class="note-text">ğŸ“ ${item.note}</span>` : '';
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                <td>${item.date.slice(5)}</td>
                <td>
                    ${item.bedTime} - ${item.wakeTime}
                    ${noteHtml}
                </td>
                <td>
                    <span style="color:${item.duration>=7?'#20bf6b':'#f39c12'};font-weight:bold">${item.duration}h</span><br>
                    <span style="font-size:10px; padding:1px 5px; border-radius:3px; color:white; background:${getScoreColor(item.score)}">${item.score}åˆ†</span>
                </td>
                <td><button class="act-btn" onclick="editData(${index})">æ”¹</button><button class="act-btn" onclick="deleteData(${index})">åˆ </button></td>`;
                tbody.appendChild(tr);
            });
        }

        function getScoreColor(score) {
            if(score >= 80) return '#20bf6b'; 
            if(score >= 60) return '#f39c12'; 
            return '#ff4757'; 
        }

        let myChart = null;
        function renderChart() {
            const ctx = document.getElementById('sleepChart').getContext('2d');
            if (typeof Chart === 'undefined') return;
            document.getElementById('offlineTip').style.display = 'none';

            const minW = 55;
            const w = Math.max(document.querySelector('.chart-container-wrapper').offsetWidth, sleepData.length * minW);
            document.getElementById('chartBody').style.width = `${w}px`;
            
            if (myChart) myChart.destroy();
            
            // è·å–ç”¨æˆ·è®¾å®šçš„çº¢çº¿æ•°å€¼
            const limitVal = timeToNumber(userSettings.limitTime);

            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sleepData.map(d => d.date.slice(5)),
                    datasets: [
                        { 
                            label: 'å…¥ç¡', 
                            data: sleepData.map(d => d.startVal), 
                            borderColor: '#A2D2FF', backgroundColor: '#A2D2FF', borderWidth: 2, tension: 0.3, yAxisID: 'yTime', 
                            // åŠ¨æ€ç‚¹é€»è¾‘ï¼š
                            // 1. 0ç‚¹å‰ (24.5) -> æ˜Ÿæ˜Ÿ
                            // 2. çº¢çº¿å‰ (limitVal) -> é»„è‰²
                            // 3. çº¢çº¿å -> è“è‰²
                            pointStyle: (ctx) => (ctx.raw <= 24.5) ? 'star' : 'circle',
                            pointRadius: (ctx) => (ctx.raw <= 24.5) ? 8 : 4,
                            pointBackgroundColor: (ctx) => {
                                const v = ctx.raw;
                                if (v <= 24.5) return '#ffd700'; // ğŸŒŸ
                                if (v < limitVal) return '#FDE598'; // ğŸŸ¡ è¾¾æ ‡(çº¢çº¿å‰)
                                return '#A2D2FF'; // ğŸ”µ æ™šç¡
                            },
                            pointBorderColor: (ctx) => {
                                const v = ctx.raw;
                                if (v <= 24.5) return '#ffd700';
                                if (v < limitVal) return '#FDE598';
                                return '#A2D2FF';
                            },
                            datalabels: {align:'bottom', color:'#A2D2FF', font:{size:9}, formatter: (v)=>numberToTime(v)} 
                        },
                        { 
                            label: 'èµ·åºŠ', 
                            data: sleepData.map(d => d.endVal), 
                            borderColor: '#FFC8DD', backgroundColor: '#FFC8DD', borderWidth: 2, tension: 0.3, yAxisID: 'yTime', pointRadius: 4, 
                            datalabels: {align:'top', color:'#FFC8DD', font:{size:9}, formatter: (v)=>numberToTime(v)} 
                        },
                        { 
                            label: 'æ—¶é•¿', 
                            data: sleepData.map(d => d.duration), 
                            type: 'scatter', 
                            yAxisID: 'yDuration', 
                            pointStyle: (ctx) => {
                                const v = ctx.raw; 
                                const score = calculateScore(v, sleepData[ctx.dataIndex].startVal);
                                const color = getScoreColor(score);
                                const cvs = document.createElement('canvas'); 
                                cvs.width=40; cvs.height=50; 
                                const c = cvs.getContext('2d'); 
                                c.fillStyle = color; c.beginPath(); c.roundRect(5, 0, 30, 14, 4); c.fill();
                                c.fillStyle = 'white'; c.font = 'bold 10px Arial'; c.textAlign='center'; c.fillText(score, 20, 11);
                                c.font = '14px Arial'; c.textBaseline='middle'; c.fillText(v>=7?'ğŸ”‹':'ğŸª«', 20, 24); 
                                return cvs;
                            }, 
                            datalabels: {
                                align: 'bottom', offset: 15, 
                                color: (ctx) => ctx.dataset.data[ctx.dataIndex] >= 7 ? '#20bf6b' : '#f39c12',
                                font:{size:9, weight:'bold'}, formatter:(v)=>v+'h'
                            } 
                        }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false, 
                    events: ['click'], interaction: { mode: 'nearest', axis: 'x', intersect: true },
                    layout: { padding: { top: 30, right: 80, bottom: 20 } }, 
                    clip: false,
                    plugins: { 
                        legend:{display:false}, 
                        tooltip: { enabled: true },
                        annotation: { 
                            annotations: {
                                line0: {
                                    type:'line', scaleID:'yTime', value:24, 
                                    borderColor:'#333', borderWidth:1.5, borderDash:[6,4],
                                    label: { content:'00:00', display:true, position:'end', xAdjust: 60, color:'#333', font:{size:10, weight:'bold'}, backgroundColor:'transparent' }
                                },
                                line3: {
                                    type:'line', scaleID:'yTime', value: limitVal, // åŠ¨æ€çº¢çº¿
                                    borderColor:'#ff4757', borderWidth:1, borderDash:[6,6],
                                    label: { content: numberToTime(limitVal), display:true, position:'end', xAdjust: 60, color:'#ff4757', font:{size:10, weight:'bold'}, backgroundColor:'transparent' }
                                }
                            }
                        }
                    },
                    scales: {
                        x: {grid:{display:false}}, 
                        yTime: { type:'linear', position:'left', min:21, max:46, ticks:{display:true, color:'#ccc', stepSize:2, callback:(v)=>numberToTime(v)} },
                        yDuration: { type:'linear', position:'right', grid:{display:false}, min:-30, max:14, ticks:{stepSize:2, color:'#ddd', callback:(v)=>(v>0&&v%2===0)?v+'h':''} }
                    }
                }
            });
        }
        
        // é»˜è®¤æ—¥æœŸè®¾ä¸ºæ˜¨å¤©
        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1);
        document.getElementById('dateInput').valueAsDate = yesterday;
        
        saveAndRender();
        
        setTimeout(() => {
            const wrapper = document.querySelector('.chart-container-wrapper');
            wrapper.scrollLeft = wrapper.scrollWidth;
        }, 500);

        document.getElementById('sleepChart').onclick = function(evt) {
            const points = myChart.getElementsAtEventForMode(evt, 'nearest', { intersect: true }, true);
            if (points.length === 0) {
                myChart.tooltip.setActiveElements([], {x: 0, y: 0});
                myChart.update();
            }
        };
    </script>
</body>
</html>
